@model SharedObjects.ValueObjects.VDetail
@using SharedObjects.ValueObjects;
@using SharedObjects.Extensions;

@{
    ViewData["Title"] = "Submission";
    var Approval_get = ViewData["Approval_get"] as IEnumerable<SharedObjects.ValueObjects.VApproval>;
    var Approval_get_current = ViewData["Approval_get_current"] as IEnumerable<SharedObjects.ValueObjects.VApproval>;
    var Approval_get_deviation = ViewData["Approval_get_deviation"] as IEnumerable<SharedObjects.ValueObjects.VApproval>;
}
<div class="container-fluid">
    <div class="row">

        <div class="col-md-12" style="min-height: auto !important;height: auto !important;">

            <!-- BEGIN EXAMPLE TABLE PORTLET-->
            <div class="portlet light" style="min-height: auto !important;height: auto !important">
                <div class="portlet-title">

                    <div class="caption col-md-12">
                        <span class="caption-subject font-green-sharp bold uppercase">
                            Submit for approval
                        </span>
                    </div>
                    <div class="form-group col-md-2 pull-left">
                        <label class="text-center bold font-green-sharp" for="">Customer</label>
                        <input class="form-control" value="@Model.CustName" readonly />

                    </div>
                    <div class="form-group col-md-2 pull-left">
                        <label class="text-center bold font-green-sharp" for="">Station</label>
                        <input class="form-control" value="@Model.Station" readonly />

                    </div>
                    <div class="form-group col-md-2 pull-left">
                        <label class="text-center bold font-green-sharp" for="">Assembly Number</label>
                        <input class="form-control" value="@Model.AssemblyNumber" readonly />

                    </div>
                    <div class="form-group col-md-2 pull-left">
                        <label class="text-center bold font-green-sharp" for="">Assembly Revision	</label>
                        <input class="form-control" value="@Model.AssemblyRevision" readonly />

                    </div>
                    <div class="form-group col-md-2 pull-left">
                        <label class="text-center bold font-green-sharp" for="">Type</label>
                        <input class="form-control" value="@Model.Type" readonly />
                    </div>
                    <div class="form-group col-md-2 pull-left">
                        <label class="text-center bold font-green-sharp" for="">Platform</label>
                        <input class="form-control" value="@Model.Platform" readonly />

                    </div>
                    <div class="form-group col-md-4 pull-left">
                        <label class="text-center bold font-green-sharp" for="">Test Script Id</label>
                        <input class="form-control" id="txt-scriptid" value="@Model.ScriptId" readonly />

                    </div>
                    <div class="form-group col-md-2 pull-left">
                        <label class="text-center bold font-green-sharp" for="">Creation Date</label>
                        <input class="form-control" value="@Model.creationDate" readonly />
                    </div>
                    <div class="form-group col-md-2 pull-left">
                        <label class="text-center bold font-green-sharp" for="">Created By</label>
                        <input class="form-control" value="@Model.CreatedName" readonly />
                    </div>
                    <div class="form-group col-md-2 pull-left">
                        <label class="text-center bold font-green-sharp" for="">Status</label>
                        <input class="form-control" value="@Model.StatusName" style="background-color: @Model.StatusColour" readonly />
                    </div>



                    @if (Model.StatusId == 1)
                    {
                        <div class="form-group col-md-12 pull-left">
                            <form id="frm-submit">

                                <div class="form-group col-md-2 pull-left">
                                    <label class="text-center bold font-green-sharp" for="">Script Name</label>
                                    <input id="txt-scriptname" name="scriptname" type="text" class="form-control" value="@Model.ScriptName" />
                                </div>
                                <div class="form-group col-md-2 pull-left">
                                    <label class="text-center bold font-green-sharp" for="">Script Revision</label>
                                    <input id="txt-scriptrev" name="scriptrev" type="text" class="form-control" value="@Model.ScriptRev" />
                                </div>

                                @*<div class="form-group col-md-2 pull-left">
                                        <label class="text-center bold font-green-sharp" for="">Firmware</label>
                                        <input id="txt-firmware" name="firmware" type="text" class="form-control" value="@Model.Firmware" />
                                    </div>
                                    <div class="form-group col-md-2 pull-left">
                                        <label class="text-center bold font-green-sharp" for="">Firmware File Path</label>
                                        <input id="txt-firmwarerev" name="firmwarerev" type="text" class="form-control" value="@Model.FirmwareRevision" />
                                    </div>*@

                                <div class="form-group col-md-4 pull-left">
                                    <label class="text-center bold font-green-sharp" for="">Original Script</label>
                                    <input id="txt-script" name="script" type="file" class="form-control" accept=".jts" />
                                </div>

                                <div class="form-group col-md-4 pull-left">
                                    <label class="text-center bold font-green-sharp" for="">Encrypted Script</label>
                                    <input id="txt-encrypted" name="encrypted" type="file" class="form-control" accept=".jts_encrypted" />
                                </div>


                                <div class="form-group col-md-6 pull-left">
                                    <label class="text-center bold font-green-sharp" for="">Description</label>
                                    <input id="txt-description" name="description" type="text" class="form-control" value="@Model.Description" />
                                </div>
                                <div class="form-group col-md-6 pull-left">
                                    <label class="text-center bold font-green-sharp" for="">Change Detail</label>
                                    @*<textarea id="txt-changeDetail" class="cell" rows="6" cols="40"></textarea>*@
                                    <input id="txt-changeDetail" name="changeDetail" type="text" class="form-control" />

                                </div>
                                @if (Model.TypeId != 1)
                                {
                                    <div class="form-group col-md-4 pull-left">
                                        <label class="text-center bold font-green-sharp" for="">PCN or Dev Number</label>
                                        <input id="txt-PCNorDevNumber" name="PCNorDevNumber" type="text" class="form-control" />
                                    </div>
                                    @*<div class="form-group col-md-4 pull-left">
                                            <label class="text-center bold font-green-sharp" for="">From</label>
                                            <input id="txt-from" name="from" type="date" class="form-control" />
                                        </div>
                                        <div class="form-group col-md-4 pull-left">
                                            <label class="text-center bold font-green-sharp" for="">To</label>
                                            <input id="txt-to" name="to" type="date" class="form-control" />
                                        </div>
                                        <button type="button" id="test">Test</button>*@
                                }
                                <div class="form-group col-md-12">
                                    <a class="btn btn-success" id="btn-submit" data-reid="@Model.ReqId" data-typeid="@Model.TypeId">Submit</a>
                                </div>
                            </form>
                        </div>
                    }
                    else
                    {
                        <div class="form-group col-md-12">

                            <div class="form-group col-md-2 pull-left">
                                <label class="text-center bold font-green-sharp" for="">Script Name</label>
                                <input class="form-control" value="@Model.ScriptName" readonly />

                            </div>
                            <div class="form-group col-md-2 pull-left">
                                <label class="text-center bold font-green-sharp" for="">Script Revision</label>
                                <input class="form-control" value="@Model.ScriptRev" readonly />

                            </div>
                            @*<div class="form-group col-md-2 pull-left">
                                    <label class="text-center bold font-green-sharp" for="">Firmware</label>
                                    <input class="form-control" value="@Model.Firmware" readonly />

                                </div>
                                <div class="form-group col-md-2 pull-left">
                                    <label class="text-center bold font-green-sharp" for="">Firmware File Path</label>
                                    <input class="form-control" value="@Model.FirmwareRevision" readonly />

                                </div>*@



                            <div class="form-group col-md-4 pull-left" style="height:62px">
                                <label class="text-center bold font-green-sharp" for="">Script File Name</label>
                                <a class="wrapper" href="@Url.Action("DownloadFile", "Request", new { fileName = @Model.ScriptFileName })">@Model.ScriptFileName</a>
                            </div>
                            <div class="form-group col-md-4 pull-left" style="height:62px">
                                <label class="text-center bold font-green-sharp" for="">Encrypted File Name</label>
                                <a class="wrapper" href="@Url.Action("DownloadFile", "Request", new { fileName = @Model.EncriptedFileName })">@Model.EncriptedFileName</a>
                            </div>
                            <div class="form-group col-md-4 pull-left">
                                <label class="text-center bold font-green-sharp" for="">File Hash</label>
                                <input class="form-control" value="@Model.FileHash" readonly />
                            </div>
                            <div class="form-group col-md-4 pull-left">
                                <label class="text-center bold font-green-sharp" for="">Change Detail</label>
                                <input class="form-control" value="@Model.ChangeDetail" readonly />
                            </div>
                            <div class="form-group col-md-4 pull-left">
                                <label class="text-center bold font-green-sharp" for="">Description</label>
                                <input class="form-control" value="@Model.Description" readonly />
                            </div>
                            @if (Model.TypeId != 1)
                            {
                                <div class="form-group col-md-2 pull-left">
                                    <label class="text-center bold font-green-sharp" for="">PCN or Dev Number</label>
                                    <input class="form-control" value="@Model.PcnorDevNumber" readonly />
                                </div>
                            }
                        </div>
                        <div class="form-group col-md-12">
                            <label class="text-center bold font-green-sharp" for="">Approval History</label>
                        </div>
                        <table class="table table-bordered table-hover table-striped table-responsive">
                            <thead>
                                <tr class="text-center bold">
                                    <th class="text-center">RouteName</th>
                                    <th class="text-center">Name</th>
                                    @*<th>Email</th>*@
                                    <th class="text-center">Status</th>
                                    <th class="text-center">UpdateDate</th>
                                    <th class="text-center">Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Approval_get.GroupBy(u => u.RouteName)  // group by RouteName
                                          .Select(g => new VApproval   // select values
                                                               {
                                              RouteName = g.First().RouteName,
                                              IsClosed = g.First().IsClosed,
                                              UpdateDate = g.First().UpdateDate,
                                              UpdatedName = g.First().UpdatedName,
                                              Remarks = g.First().Remarks,
                                              Name = string.Join(", ", g.Select(u => u.Name)),
                                              Email = string.Join(", ", g.Select(u => u.Email))
                                          })
                                          .ToList())
                                {
                                    <tr>
                                        <td class="text-center">@item.RouteName</td>
                                        @{
                                            string b = item.IsClosed == 1 ? item.UpdatedName : item.Name;
                                            <td>
                                                @b
                                            </td>
                                        }
                                        @{
                                            string a = item.IsClosed == 1 ? "Closed" : "Pending Approval";
                                            <td>
                                                @a
                                            </td>
                                        }
                                        <td>@item.UpdateDate</td>
                                        <td>@item.Remarks</td>
                                    </tr>
                                }

                                @foreach (var item in Approval_get_deviation.GroupBy(u => u.RouteName)  // group by RouteName
                                           .Select(g => new VApproval   // select values
                                                                {
                                               RouteName = g.First().RouteName,
                                               IsClosed = g.First().IsClosed,
                                               UpdateDate = g.First().UpdateDate,
                                               UpdatedName = g.First().UpdatedName,
                                               Remarks = g.First().Remarks,
                                               Name = string.Join(", ", g.Select(u => u.Name)),
                                               Email = string.Join(", ", g.Select(u => u.Email))
                                           })
                                           .ToList())
                                {
                                    <tr>
                                        <td class="text-center">@item.RouteName - Deviation</td>
                                        @{
                                            string b = item.IsClosed == 1 ? item.UpdatedName : item.Name;
                                            <td>
                                                @b
                                            </td>
                                        }
                                        @{
                                            string a = item.IsClosed == 1 ? "Closed" : "Pending Approval";
                                            <td>
                                                @a
                                            </td>
                                        }
                                        <td>@item.UpdateDate</td>
                                        <td>@item.Remarks</td>
                                    </tr>
                                }

                            </tbody>
                        </table>



                        @if (Approval_get_current.Where(s => s.NTLogin == User.GetSpecificClaim("Ntlogin")).Any() ||
                            (Approval_get_deviation.Where(s => s.NTLogin == User.GetSpecificClaim("Ntlogin")).Any() && 
                        Model.StatusId == 4 && Model.TypeId == 2 && User.GetSpecificClaim("Ntlogin") == Model.CreatedBy))
                        {
                            <div class="form-group col-md-12 pull-left">
                                <label class="text-center bold font-green-sharp" for="">Remark</label>
                                <input class="form-control" id="txt-remark" />
                            </div>
                        }
                        @if (Approval_get_current.Where(s => s.NTLogin == User.GetSpecificClaim("Ntlogin")).Any())
                        {
                            <div class="form-group col-md-1">
                                <a class="btn btn-success" id="btn-approve" data-reqid="@Model.ReqId" data-routeid="@Approval_get_current.FirstOrDefault().RouteId">Approve</a>
                            </div>

                            <div class="form-group col-md-1">
                                <a class="btn btn-success" id="btn-reject" data-reqid="@Model.ReqId" data-routeid="@Approval_get_current.FirstOrDefault().RouteId">Reject</a>
                            </div>
                        }
                        if (Model.StatusId == 4 && Model.TypeId == 2 && User.GetSpecificClaim("Ntlogin") == Model.CreatedBy)
                        {
                            <div class="form-group col-md-1">
                                <a class="btn btn-success" id="btn-close" data-reqid="@Model.ReqId">Close Deviation</a>
                            </div>
                        }
                        @* if (Model.StatusId == 5 && Model.TypeId == 2 && User.GetSpecificClaim("Ntlogin") == "1099969")
                            {
                                <div class="form-group col-md-1">
                                    <a class="btn btn-success" id="btn-close-approval" data-reqid="@Model.ReqId">Approval For Deviation Closure</a>
                                </div>
                            }*@
                        if (Model.StatusId == 5 && Model.TypeId == 2 && Approval_get_deviation.Where(s => s.NTLogin == User.GetSpecificClaim("Ntlogin")).Any())
                        {
                            <div class="form-group col-md-1">
                                <a class="btn btn-success" id="btn-close-approval" data-reqid="@Model.ReqId">Approval For Deviation Closure</a>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts{

    <script src="~/js/request.js"></script>
    <script>
        document.getElementById('txt-encrypted').addEventListener('change', Encripted)
        function Encripted() {
            var reader = new FileReader(); // define a Reader
            var file = $('#txt-encrypted')[0].files[0]; // get the File obect
            if (!file) {
                alert('no encrypted file selected');
                return
            } // check if user selected a file
            reader.onload = function (f) {
                var file_result = this.result; // this == reader, get the loaded file "result"
                var file_wordArr = CryptoJS.lib.WordArray.create(file_result); //convert blob to WordArray , see https://code.google.com/p/crypto-js/issues/detail?id=67
                var sha1_hash = CryptoJS.SHA1(file_wordArr); //calculate SHA1 hash
                var sha1_hash1 = sha1_hash.toString()
                //alert("Calculated SHA1:" + sha1_hash.toString()); //output result
                $('#txt-encrypted').attr('data-hash-encrypted', sha1_hash1)
            };
            reader.readAsArrayBuffer(file); // read the file as ArrayBuffer
        }
        document.getElementById('txt-script').addEventListener('change', Script)

        function Script() {
            var reader = new FileReader(); // define a Reader
            var file = $('#txt-script')[0].files[0]; // get the File obect
            if (!file) {
                alert('no script file selected');
                return
            } // check if user selected a file
            reader.onload = function (f) {
                var file_result = this.result; // this == reader, get the loaded file "result"
                var file_wordArr = CryptoJS.lib.WordArray.create(file_result); //convert blob to WordArray , see https://code.google.com/p/crypto-js/issues/detail?id=67
                var sha1_hash = CryptoJS.SHA1(file_wordArr); //calculate SHA1 hash
                var sha1_hash1 = sha1_hash.toString()
                //alert("Calculated SHA1:" + sha1_hash.toString()); //output result
                $('#txt-script').attr('data-hash-script', sha1_hash1)
            };
            reader.readAsArrayBuffer(file); // read the file as ArrayBuffer
        }
    </script>
}
